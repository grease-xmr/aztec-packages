# Deploy fisherman network with specified L1 network
# This workflow can be called directly or from other workflows
name: Deploy Fisherman Network

on:
  workflow_call:
    inputs:
      l1_network:
        description: "L1 network (sepolia or mainnet)"
        required: true
        type: string
      semver:
        description: "Semver version (e.g., 2.3.4)"
        required: true
        type: string
      ref:
        description: "Git ref to checkout"
        required: false
        type: string
  workflow_dispatch:
    inputs:
      l1_network:
        description: "L1 network (sepolia or mainnet)"
        required: true
        type: choice
        options:
          - sepolia
          - mainnet
      semver:
        description: "Semver version (e.g., 2.3.4)"
        required: true
        type: string

concurrency:
  group: deploy-fisherman-network-${{ inputs.l1_network }}-${{ inputs.semver }}-${{ github.ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy-fisherman:
    runs-on: ubuntu-latest
    env:
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json
    steps:
      - name: Determine checkout ref
        id: checkout-ref
        run: |
          # Use inputs.ref if provided (workflow_call), otherwise use github.ref
          if [[ -n "${{ inputs.ref }}" ]]; then
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ steps.checkout-ref.outputs.ref }}
          fetch-depth: 0
          persist-credentials: false
          submodules: recursive # Initialize git submodules for l1-contracts dependencies

      - name: Validate inputs
        run: |
          # Validate l1_network
          if [[ "${{ inputs.l1_network }}" != "sepolia" && "${{ inputs.l1_network }}" != "mainnet" ]]; then
            echo "Error: L1 network must be 'sepolia' or 'mainnet', got '${{ inputs.l1_network }}'"
            exit 1
          fi

          # Validate environment file exists
          if [[ ! -f "spartan/environments/ignition-fisherman.env" ]]; then
            echo "Error: Environment file not found: spartan/environments/ignition-fisherman.env"
            exit 1
          fi

          # Validate semver format
          if ! echo "${{ inputs.semver }}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$'; then
            echo "Error: Invalid semver format '${{ inputs.semver }}'. Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

          # Extract major version for v2 check
          major_version="${{ inputs.semver }}"
          major_version="${major_version%%.*}"
          echo "MAJOR_VERSION=$major_version" >> $GITHUB_ENV

      - name: Store the GCP key in a file
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          set +x
          umask 077
          printf '%s' "$GCP_SA_KEY" > "$GOOGLE_APPLICATION_CREDENTIALS"
          jq -e . "$GOOGLE_APPLICATION_CREDENTIALS" >/dev/null

      - name: Setup GCP authentication
        run: |
          gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"

      - name: Setup gcloud and install GKE auth plugin
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: "gke-gcloud-auth-plugin"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1
        with:
          terraform_version: "1.7.5"
          terraform_wrapper: false # Disable the wrapper that adds debug output, this messes with reading terraform output

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Set environment variables
        run: |
          # Set environment variables for ignition-fisherman.env
          if [[ "${{ inputs.l1_network }}" == "sepolia" ]]; then
            echo "NETWORK=staging-ignition" >> $GITHUB_ENV
            echo "NAMESPACE=ignition-fisherman-sepolia" >> $GITHUB_ENV
            echo "ETHEREUM_CHAIN_ID=11155111" >> $GITHUB_ENV
            echo "L1_NETWORK=sepolia" >> $GITHUB_ENV
            echo "SNAPSHOT_BUCKET_DIRECTORY=ignition-sepolia" >> $GITHUB_ENV
            echo "USE_NETWORK_CONFIG=true" >> $GITHUB_ENV
          elif [[ "${{ inputs.l1_network }}" == "mainnet" ]]; then
            echo "NETWORK=mainnet" >> $GITHUB_ENV
            echo "NAMESPACE=ignition-fisherman-mainnet" >> $GITHUB_ENV
            echo "ETHEREUM_CHAIN_ID=1" >> $GITHUB_ENV
            echo "L1_NETWORK=mainnet" >> $GITHUB_ENV
            echo "SNAPSHOT_BUCKET_DIRECTORY=ignition-mainnet" >> $GITHUB_ENV
            echo "USE_NETWORK_CONFIG=true" >> $GITHUB_ENV
          fi

      - name: Deploy fisherman network
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GITHUB_TOKEN: ${{ secrets.AZTEC_BOT_GITHUB_TOKEN }}
          RUN_ID: ${{ github.run_id }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          REF_NAME: "v${{ inputs.semver }}"
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          AZTEC_DOCKER_IMAGE: "aztecprotocol/aztec:${{ inputs.semver }}"
        run: |
          echo "Deploying fisherman network on L1: ${{ inputs.l1_network }}"
          echo "Using image: $AZTEC_DOCKER_IMAGE"
          echo "Using branch/ref: ${{ steps.checkout-ref.outputs.ref }}"
          echo "Network: $NETWORK"
          echo "Namespace: $NAMESPACE"
          echo "Ethereum Chain ID: $ETHEREUM_CHAIN_ID"
          echo "L1 Network: $L1_NETWORK"
          echo "Snapshot Bucket Directory: $SNAPSHOT_BUCKET_DIRECTORY"
          echo "Use Network Config: $USE_NETWORK_CONFIG"

          cd spartan
          ./scripts/install_deps.sh
          ./scripts/network_deploy.sh ignition-fisherman

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          if [ -n "${SLACK_BOT_TOKEN}" ]; then
            read -r -d '' data <<EOF || true
            {
              "channel": "#alerts-fisherman-${{ inputs.l1_network }}",
              "text": "Deploy Fisherman Network workflow FAILED for *${{ inputs.l1_network }}* (version ${{ inputs.semver }}): <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
            }
          EOF
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "$data"
          fi
