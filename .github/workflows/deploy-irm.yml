# Deploys the IRM to a given network

name: Deploy IRM

on:
  workflow_call:
    inputs:
      network:
        description: "Network that IRM will be monitoring e.g. testnet, staging-ignition..."
        required: true
        type: string
        default: "testnet"
      namespace:
        description: "Namespace to use for fetching L1 contract addresses. Network name will be used if not provided."
        required: false
        type: string
      monitoring_namespace:
        description: "The IRM Namespace. Will default to {namespace}-irm if not provided."
        required: false
        type: string
      l1_network:
        description: "L1 network to deploy IRM to"
        required: true
        type: string
        default: "sepolia"
      cluster:
        description: "The cluster to deploy to, e.g. aztec-gke-private"
        required: true
        type: string
        default: "aztec-gke-private"
  workflow_dispatch:
    inputs:
      network:
        description: "Network that IRM will be monitoring e.g. testnet, staging-ignition..."
        required: true
        type: string
        default: "testnet"
      namespace:
        description: "Namespace to use for fetching L1 contract addresses. Network name will be used if not provided."
        required: false
        type: string
      monitoring_namespace:
        description: "The IRM Namespace. Will default to {namespace}-irm if not provided."
        required: false
        type: string
      l1_network:
        description: "L1 network to deploy IRM to"
        required: true
        type: string
        default: "sepolia"
      cluster:
        description: "The cluster to deploy to, e.g. aztec-gke-private"
        required: true
        type: string
        default: "aztec-gke-private"

jobs:
  deploy-irm:
    env:
      CLUSTER_NAME: ${{ inputs.cluster }}
      GKE_CLUSTER_CONTEXT: "gke_testnet-440309_us-west1-a_${{ inputs.cluster }}"
      REGION: us-west1-a
      INFURA_SECRET_NAME: infura-${{ inputs.l1_network }}-url

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ steps.checkout-ref.outputs.ref }}
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl with GKE cluster
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --region ${{ env.REGION }}

      - name: Validate inputs
        run: |
          # Validate l1_network
          if [[ "${{ inputs.l1_network }}" != "sepolia" && "${{ inputs.l1_network }}" != "mainnet" ]]; then
            echo "Error: L1 network must be 'sepolia' or 'mainnet', got '${{ inputs.l1_network }}'"
            exit 1
          fi

          # Validate namespace to monitor
          # Determine namespace to monitor (defaults to network when not provided)
          NAMESPACE_TO_MONITOR="${{ inputs.namespace }}"
          if [[ -z "$NAMESPACE_TO_MONITOR" ]]; then
            NAMESPACE_TO_MONITOR="${{ inputs.network }}"
          fi

          # Determine IRM namespace (defaults to {namespace}-irm when not provided)
          EFFECTIVE_MONITORING_NAMESPACE="${{ inputs.monitoring_namespace }}"
          if [[ -z "$EFFECTIVE_MONITORING_NAMESPACE" ]]; then
            EFFECTIVE_MONITORING_NAMESPACE="${NAMESPACE_TO_MONITOR}-irm"
          fi

          echo "Namespace to monitor: ${NAMESPACE_TO_MONITOR}"
          echo "IRM namespace: ${EFFECTIVE_MONITORING_NAMESPACE}"

          # Ensure the namespace to monitor exists in the selected cluster
          if ! kubectl get namespace "${NAMESPACE_TO_MONITOR}" >/dev/null 2>&1; then
            echo "Error: Namespace '${NAMESPACE_TO_MONITOR}' does not exist in cluster '${CLUSTER_NAME}' (region '${REGION}')"
            echo "Available namespaces:"
            kubectl get namespaces -o name || true
            exit 1
          fi

          # Export values for use in downstream steps
          echo "NAMESPACE=${NAMESPACE_TO_MONITOR}" >> "$GITHUB_ENV"
          echo "MONITORING_NAMESPACE=${EFFECTIVE_MONITORING_NAMESPACE}" >> "$GITHUB_ENV"

      - name: Deploy IRM
        run: |
          echo "Deploying IRM to network: ${{ inputs.network }}"
          echo "Namespace to monitor: ${NAMESPACE}"
          echo "Monitoring namespace: ${MONITORING_NAMESPACE}"
          echo "L1 network: ${{ inputs.l1_network }}"

          ./spartan/metrics/irm-monitor/scripts/update-monitoring.sh $NAMESPACE $MONITORING_NAMESPACE ${{ inputs.network }} $INFURA_SECRET_NAME
