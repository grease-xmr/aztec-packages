#!/usr/bin/env bash
set -euo pipefail

export AZTEC_PATH="${AZTEC_PATH:-$HOME/.aztec}"
DEFAULT_VERSION=$(cat "$AZTEC_PATH/default_version" 2> /dev/null || echo latest)
export VERSION="${VERSION:-$DEFAULT_VERSION}"
export DOCKER_REPO="${DOCKER_REPO:-"aztecprotocol/aztec"}"

# Take copy of command-line arguments, so we can mutate to parse.
if [ $# -eq 0 ]; then
  args=("--help")
else
  args=("$@")
fi

while [ "$#" -gt 0 ]; do
  case $1 in
    -p | --port)
      # Override default port exposed on container.
      AZTEC_PORT="$2"
      shift 2
      ;;
    --p2p.p2pPort)
      P2P_PORT="$2"
      shift 2
      ;;
    --p2p.p2pBroadcastPort)
      P2P_BROADCAST_PORT="$2"
      shift 2
      ;;
    -a | --anvil-port)
      # Override default port exposed on container.
      ANVIL_PORT="$2"
      shift 2
      ;;
    --admin-port)
      ADMIN_PORT="$2"
      shift 2
      ;;
    --help)
      NO_PORT_FORWARDING=1
      shift 1
      ;;
    *)
      shift
      ;;
  esac
done
# Reset positional args.
set -- "${args[@]}"

function get_env_vars {
  docker run --rm --entrypoint /bin/bash $DOCKER_REPO:$VERSION -c "cat /usr/src/yarn-project/foundation/src/config/env_var.ts" |
    awk -F"'" '{for(i=2;i<=NF;i+=2) printf $i " "}'
}

function validate_working_directory {
  # Validate working directory is under $HOME for Docker containerization
  if [[ $PWD != ${HOME}* ]]; then
    >&2 echo "Due to how we containerize our applications, we require your working directory to be somewhere within $HOME."
    exit 1
  fi
}

function run_nargo {
  # Helper function to run nargo commands with proper Docker setup
  # Usage: run_nargo <command> [args...]

  # Determine if we need interactive/tty flags
  if [ -t 0 ]; then
    if [ -t 1 ]; then
      TTY_FLAGS="-ti"
    else
      TTY_FLAGS="-i"
    fi
  fi

  # Run nargo via docker
  docker run ${TTY_FLAGS:-} \
    --user $(id -u):$(id -g) \
    -v $HOME:$HOME \
    -e HOME=$HOME \
    --workdir="$PWD" \
    --entrypoint=/usr/src/noir/noir-repo/target/release/nargo \
    $DOCKER_REPO:$VERSION "$@"
}

function setup_aztec_contract_project {
  # Setup an Aztec contract project by adding dependencies and creating the main.nr template
  # Usage: setup_aztec_contract_project <project_path>
  # If project_path is ".", operates in current directory
  local PROJECT_DIR="$1"

  # Get the actual aztec version for the git tag
  AZTEC_VERSION=$(docker run --rm --entrypoint=node $DOCKER_REPO:$VERSION --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js --version 2>/dev/null | tr -d '\n\r')

  # Determine file paths based on whether we're in current dir or a subdirectory
  if [ "$PROJECT_DIR" = "." ]; then
    NARGO_TOML_PATH="Nargo.toml"
    MAIN_NR_PATH="src/main.nr"
  else
    NARGO_TOML_PATH="$PROJECT_DIR/Nargo.toml"
    MAIN_NR_PATH="$PROJECT_DIR/src/main.nr"
  fi

  # Add aztec dependency to Nargo.toml
  if [ -f "$NARGO_TOML_PATH" ]; then
    echo "" >> "$NARGO_TOML_PATH"
    echo "aztec = { git=\"https://github.com/AztecProtocol/aztec-nr\", tag=\"v${AZTEC_VERSION}\", directory=\"aztec\" }" >> "$NARGO_TOML_PATH"
    echo "Added aztec dependency (v${AZTEC_VERSION}) to Nargo.toml"
  else
    >&2 echo "Warning: Could not find Nargo.toml at $NARGO_TOML_PATH to add aztec dependency"
  fi

  # Replace the contents of main.nr with the Aztec contract template
  if [ -f "$MAIN_NR_PATH" ]; then
    cat > "$MAIN_NR_PATH" << 'EOF'
use aztec::macros::aztec;

#[aztec]
contract Main {}
EOF
    echo "Created main.nr with Aztec contract template"
  else
    >&2 echo "Warning: Could not find main.nr at $MAIN_NR_PATH"
  fi
}

function parse_project_flags_and_build_nargo_args {
  # Parse project type flags and build nargo arguments
  # Usage: Call this function and it will populate NARGO_ARGS, HAS_TYPE_FLAG, IS_CONTRACT
  # For 'new' command: pass "new" as first arg and handle PATH specially
  # For 'init' command: pass "init" as first arg
  local COMMAND="$1"
  shift

  NARGO_ARGS=("$COMMAND")
  HAS_TYPE_FLAG=false
  IS_CONTRACT=false
  PROJECT_PATH=""

  while [ "$#" -gt 0 ]; do
    case $1 in
      --name)
        NARGO_ARGS+=("--name" "$2")
        shift 2
        ;;
      --lib)
        NARGO_ARGS+=("--lib")
        HAS_TYPE_FLAG=true
        shift
        ;;
      --bin)
        NARGO_ARGS+=("--bin")
        HAS_TYPE_FLAG=true
        shift
        ;;
      --contract)
        NARGO_ARGS+=("--contract")
        HAS_TYPE_FLAG=true
        IS_CONTRACT=true
        shift
        ;;
      --help|-h)
        return 2  # Special return code to indicate help was requested
        ;;
      -*)
        echo "Unknown option: $1"
        echo "Run 'aztec $COMMAND --help' for usage information"
        exit 1
        ;;
      *)
        # For 'new' command, this is the PATH argument
        if [ "$COMMAND" = "new" ]; then
          PROJECT_PATH="$1"
        fi
        NARGO_ARGS+=("$1")
        shift
        ;;
    esac
  done

  # Default to --contract if no type flag was provided
  if [ "$HAS_TYPE_FLAG" = false ]; then
    NARGO_ARGS+=("--contract")
    IS_CONTRACT=true
  fi

  return 0
}

case ${1:-} in
  compile)
    shift

    # If help is requested, show Aztec-specific info then run nargo compile help and then exit in order to not trigger
    # transpilation
    for arg in "$@"; do
      if [ "$arg" == "--help" ] || [ "$arg" == "-h" ]; then
        cat << 'EOF'
Aztec Compile - Compile Aztec Noir contracts

This command compiles Aztec Noir contracts using nargo and then automatically
postprocesses them to generate Aztec-specific artifacts including:
  - Transpiled contract artifacts
  - Verification keys

The compiled contracts will be placed in the target/ directory by default.

AZTEC-SPECIFIC NOTES:
  - Working directory must be under $HOME due to Docker containerization
  - Compilation automatically includes contract postprocessing
  - Use standard nargo compile options (see below)

ENVIRONMENT VARIABLES:
  AZTEC_PATH    Path to Aztec installation (default: $HOME/.aztec)
  VERSION       Aztec version to use (default: from $AZTEC_PATH/default_version)
  DOCKER_REPO   Docker repository (default: aztecprotocol/aztec)

---
Underlying nargo compile options:

EOF
        # Run nargo compile help
        run_nargo compile $arg
        exit 0
      fi
    done

    # We didn't need to perform this check for help because there we don't need to access any files.
    validate_working_directory

    # Run nargo compile
    run_nargo compile "$@"

    # Check if nargo compile succeeded
    if [ $? -ne 0 ]; then
      >&2 echo "Compilation failed!"
      exit 1
    fi

    echo "Postprocessing contract..."

    docker run ${TTY_FLAGS:-} \
      --user $(id -u):$(id -g) \
      -v $HOME:$HOME \
      -e HOME=$HOME \
      --workdir="$PWD" \
      --entrypoint=/usr/src/barretenberg/cpp/build/bin/bb-avm \
      $DOCKER_REPO:$VERSION aztec_process

    echo "Compilation complete!"
    ;;
  test)
    shift

    export ENV_VARS_TO_INJECT="LOG_LEVEL"
    export LOG_LEVEL="${LOG_LEVEL:-info}"

    # Properly escape all arguments
    args_str=$(printf '%q ' "$@")

    # TODO: Need to force ipv4 here with 127.0.0.1 for some reason. TXE's not on ipv6?
    exec $(dirname $0)/.aztec-run "" bash -c "
      node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --txe --port 8081 &
      while ! nc -z 127.0.0.1 8081 &>/dev/null; do sleep 0.2; done
      export NARGO_FOREIGN_CALL_TIMEOUT=300000
      /usr/src/noir/noir-repo/target/release/nargo test --silence-warnings --pedantic-solving --oracle-resolver http://127.0.0.1:8081 $args_str
    "
    ;;
  start|supervised-start)
    SUPERVISED=0
    if [ "$1" == "supervised-start" ]; then
      SUPERVISED=1
    fi

    shift

    export ENV_VARS_TO_INJECT="$(get_env_vars)"

    # Dynamic port assignments, .aztec-run will expose the array PORTS_TO_EXPOSE as a space-separated string.
    AZTEC_PORT=${AZTEC_PORT:-8080}
    export PORTS_TO_EXPOSE="$AZTEC_PORT:$AZTEC_PORT"

    # Appends 8 char hex to avoid container name clashes
    export CONTAINER_NAME=aztec-start-$(printf "%08x" $((RANDOM * RANDOM)))

    if [ "${1:-}" == "--sandbox" ]; then
      if [ "$SUPERVISED" == "1" ]; then
        echo "supervised-start is not compatible with --sandbox. Please use regular start command"
        exit 1
      fi

      # TODO: This entire special case should go away.
      # Sandbox mode should start it's own anvil.
      # We should not have to provide a binary path and working dir.
      # Why is this not just determined and chosen at runtime?
      # In fact almost none of these should not have to be set if we have sensible defaults.
      export ARCHIVER_POLLING_INTERVAL_MS=500
      export P2P_BLOCK_CHECK_INTERVAL_MS=500
      export SEQ_TX_POLLING_INTERVAL_MS=500
      export WS_BLOCK_CHECK_INTERVAL_MS=500
      export ARCHIVER_VIEM_POLLING_INTERVAL_MS=500
      export TEST_ACCOUNTS=${TEST_ACCOUNTS:-true}
      export LOG_LEVEL=${LOG_LEVEL:-info;silent:sequencer;verbose:debug_log}
      export DEPLOY_AZTEC_CONTRACTS_SALT=${DEPLOY_AZTEC_CONTRACTS_SALT:-$RANDOM}

      ANVIL_PORT=${ANVIL_PORT:-8545}
      anvil_port_assignment="$ANVIL_PORT:8545"

      export L1_CHAIN_ID=${L1_CHAIN_ID:-31337}
      export ETHEREUM_HOSTS=${ETHEREUM_HOSTS:-"http://127.0.0.1:${ANVIL_PORT}"}

      PORTS_TO_EXPOSE="${PORTS_TO_EXPOSE:-} $anvil_port_assignment"

      exec $(dirname $0)/.aztec-run aztec-sandbox bash -c "
        anvil --version
        anvil --host 0.0.0.0 --silent &
        node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start \"\$@\"
      " bash "$@"
    else
      export P2P_PORT="${P2P_PORT:-40400}"
      # If the p2p broadcast port if provided, then map it to the p2p port on the container.
      if [ -n "${P2P_BROADCAST_PORT:-}" ]; then
        export P2P_BROADCAST_PORT
        P2P_TCP_BROADCAST_MAPPING="$P2P_BROADCAST_PORT:$P2P_PORT"
        P2P_UDP_BROADCAST_MAPPING="${P2P_TCP_BROADCAST_MAPPING}/udp"

        PORTS_TO_EXPOSE="${PORTS_TO_EXPOSE:-} $P2P_TCP_BROADCAST_MAPPING $P2P_UDP_BROADCAST_MAPPING"
      else
        P2P_TCP_LISTEN_MAPPING="$P2P_PORT:$P2P_PORT"
        P2P_UDP_LISTEN_MAPPING="${P2P_TCP_LISTEN_MAPPING}/udp"

        PORTS_TO_EXPOSE="${PORTS_TO_EXPOSE:-} $P2P_TCP_LISTEN_MAPPING $P2P_UDP_LISTEN_MAPPING"
      fi

      if [ -n "${ADMIN_PORT:-}" ]; then
        export ADMIN_PORT
        ADMIN_MAPPING="$ADMIN_PORT:$ADMIN_PORT"
        PORTS_TO_EXPOSE="${PORTS_TO_EXPOSE:-} $ADMIN_MAPPING"
      fi

      # unset PORTS_TO_EXPOSE if we're just running --help
      if [ ! -z "${NO_PORT_FORWARDING:-}" ]; then
        export PORTS_TO_EXPOSE=""
      fi

      export DOCKER_RESTART_POLICY="${DOCKER_RESTART_POLICY:-no}"
      export DOCKER_PULL_POLICY="${DOCKER_PULL_POLICY:-always}"


      SLEEP=1
      MAX_SLEEP=60
      EXP_BACKOFF=2

      RESTART_CODES="1 78 79"  # ERROR, ROLLUP_UPGRADE, VERSION_UPGRADE

      if [ "$SUPERVISED" == "1" ]; then
        echo "Starting supervised Aztec application..."
      fi
      set +e
      while true; do
        $(dirname $0)/.aztec-run aztec-start \
          node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start "$@"

        EXIT_CODE=$?

        if [ "$SUPERVISED" == "0" ]; then
          exit $EXIT_CODE
        fi

        SHOULD_RESTART=false
        for code in $RESTART_CODES; do
          if [ "$EXIT_CODE" -eq "$code" ]; then
            SHOULD_RESTART=true
            break
          fi
        done

        if [ "$SHOULD_RESTART" == "true" ]; then
          echo "Exit code $EXIT_CODE requires restart"
          SLEEP=$((SLEEP * EXP_BACKOFF))

          if [ "$SLEEP" -ge "$MAX_SLEEP" ]; then
            SLEEP="$MAX_SLEEP"
          fi

          echo "Restarting in $SLEEP seconds..."
          sleep $SLEEP

        else
          exit $EXIT_CODE
        fi
    done
    fi
    ;;
  flamegraph)
    docker run -it \
      --entrypoint /usr/src/noir-projects/noir-contracts/scripts/flamegraph.sh \
      --env SERVE=${SERVE:-0} \
      $([ "${SERVE:-0}" == "1" ] && echo "-p 8000:8000" || echo "") \
      -v $(realpath $(dirname $2))/:/tmp \
      $DOCKER_REPO:$VERSION /tmp/$(basename $2) $3
    ;;
  new)
    shift

    # Parse arguments
    parse_project_flags_and_build_nargo_args "new" "$@"
    PARSE_RESULT=$?

    # Handle help request
    if [ $PARSE_RESULT -eq 2 ]; then
      cat << 'EOF'
Aztec New - Create a new Aztec Noir project in a new directory

Usage: aztec new [OPTIONS] <PATH>

Arguments:
  <PATH>  The path to save the new project

Options:
  --name <NAME>  Name of the package [default: package directory name]
  --lib          Use a library template
  --bin          Use a binary template
  --contract     Use a contract template [default]
  -h, --help     Print help

This command creates a new Aztec Noir project using nargo and automatically
adds the Aztec.nr dependency to your Nargo.toml file.

ENVIRONMENT VARIABLES:
  AZTEC_PATH    Path to Aztec installation (default: $HOME/.aztec)
  VERSION       Aztec version to use (default: from $AZTEC_PATH/default_version)
  DOCKER_REPO   Docker repository (default: aztecprotocol/aztec)

EOF
      exit 0
    fi

    # Check if PATH was provided
    if [ -z "$PROJECT_PATH" ]; then
      echo "Error: PATH argument is required"
      echo "Usage: aztec new [OPTIONS] <PATH>"
      echo "Run 'aztec new --help' for more information"
      exit 1
    fi

    validate_working_directory

    echo "Creating new Noir project at $PROJECT_PATH..."

    # Run nargo new via docker
    run_nargo "${NARGO_ARGS[@]}"

    # Check if nargo new succeeded
    if [ $? -ne 0 ]; then
      >&2 echo "Project creation failed!"
      exit 1
    fi

    # Setup Aztec contract project (add dependency and create template)
    if [ "$IS_CONTRACT" = true ]; then
      setup_aztec_contract_project "$PROJECT_PATH"
    fi
    ;;
  init)
    shift

    # Parse arguments
    parse_project_flags_and_build_nargo_args "init" "$@"
    PARSE_RESULT=$?

    # Handle help request
    if [ $PARSE_RESULT -eq 2 ]; then
      cat << 'EOF'
Aztec Init - Create a new Aztec Noir project in the current directory

Usage: aztec init [OPTIONS]

Options:
  --name <NAME>  Name of the package [default: current directory name]
  --lib          Use a library template
  --bin          Use a binary template
  --contract     Use a contract template [default]
  -h, --help     Print help

This command creates a new Aztec Noir project in the current directory using nargo
and automatically adds the Aztec.nr dependency to your Nargo.toml file.

ENVIRONMENT VARIABLES:
  AZTEC_PATH    Path to Aztec installation (default: $HOME/.aztec)
  VERSION       Aztec version to use (default: from $AZTEC_PATH/default_version)
  DOCKER_REPO   Docker repository (default: aztecprotocol/aztec)

EOF
      exit 0
    fi

    validate_working_directory

    echo "Initializing Noir project..."

    # Run nargo init via docker
    run_nargo "${NARGO_ARGS[@]}"

    # Check if nargo init succeeded
    if [ $? -ne 0 ]; then
      >&2 echo "Initialization failed!"
      exit 1
    fi

    # Setup Aztec contract project (add dependency and create template)
    if [ "$IS_CONTRACT" = true ]; then
      setup_aztec_contract_project "."
    fi
    ;;
  fmt)
    shift

    validate_working_directory

    # Run nargo fmt
    run_nargo fmt "$@"
    ;;
  check)
    shift

    validate_working_directory

    # Run nargo check
    run_nargo check "$@"
    ;;
  lsp)
    # TODO: Drop this (and the corresponding docs in cli.ts) in case `nargo` is to be used natively (not containerized).

    # Special-case nargo's LSP command:
    # 1. include --rm for cleanup
    # 2. don't specify a user (run as root)
    # 3. don't specify a workdir
    validate_working_directory

    docker run --rm -i \
      --name aztec-nargo-lsp \
      -v $HOME:$HOME \
      -e HOME=$HOME \
      --entrypoint=/usr/src/noir/noir-repo/target/release/nargo \
      $DOCKER_REPO:$VERSION lsp
    ;;
  *)
    export ENV_VARS_TO_INJECT="SECRET_KEY"
    exec $(dirname $0)/.aztec-run aztec \
      node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js "$@"
    ;;
esac
