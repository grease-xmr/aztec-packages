#!/usr/bin/env bash
# Check if a cache artifact exists in S3 without downloading it.
# DO NOT output to stdout. This script is used in contexts where stdout is processed.
# Exit 0 if exists, exit 1 if not found or cache disabled.

NO_CD=1 source ${root:-$(git rev-parse --show-toplevel)}/ci3/source

if [ "$#" -lt 1 ]; then
  echo_stderr "Usage: $0 <tar.gz_file_to_check>"
  exit 1
fi

if [[ "$1" == *"disabled-cache"* ]]; then
  exit 1
fi

if [ "${NO_CACHE:-0}" -eq 1 ]; then
  exit 1
fi

tar_file="$1"

# Check if artifact exists in S3
if [[ -n "${S3_BUILD_CACHE_AWS_PARAMS:-}" ]]; then
  # Use AWS CLI to check object existence
  if aws $S3_BUILD_CACHE_AWS_PARAMS s3api head-object \
      --bucket aztec-ci-artifacts \
      --key "build-cache/$tar_file" &>/dev/null; then
    exit 0
  else
    exit 1
  fi
else
  # Use HTTP HEAD request to check existence
  S3_ENDPOINT="http://aztec-ci-artifacts.s3.amazonaws.com"
  if curl -s -I -f "$S3_ENDPOINT/build-cache/$tar_file" &>/dev/null; then
    exit 0
  else
    exit 1
  fi
fi
