#!/bin/bash
# Script to regenerate auto-generated Aztec.js API documentation
# Usage: ./scripts/aztecjs_reference_generation/update_docs.sh [target_version]
#
# Examples:
#   ./scripts/aztecjs_reference_generation/update_docs.sh                    # Updates all versions
#   ./scripts/aztecjs_reference_generation/update_docs.sh current            # Updates current only
#   ./scripts/aztecjs_reference_generation/update_docs.sh v2.0.2             # Updates v2.0.2 only

set -euo pipefail

TARGET_VERSION="${1:-all}"

# Constants
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCS_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
readonly SCRIPT_DIR DOCS_ROOT TARGET_VERSION

readonly AZTEC_JS_SRC="$SCRIPT_DIR/../../../yarn-project/aztec.js/src"
readonly OUTPUT_FILE="aztec_js_reference_autogen.md"
readonly SIDEBAR_POSITION="98"
readonly TITLE="Aztec.js API Reference"

echo "=== Aztec.js API Documentation Update Script ==="
echo ""

# Verify source directory exists
if [[ ! -d "$AZTEC_JS_SRC" ]]; then
  echo "Error: Source directory not found: $AZTEC_JS_SRC"
  exit 1
fi

# Step 1: Parse TypeScript files
echo "Step 1: Parsing TypeScript files from aztec.js..."
readonly TEMP_JSON="/tmp/aztec_api_docs_$(date +%s).json"
node "$SCRIPT_DIR/parse_typescript.js" \
  --source "$AZTEC_JS_SRC" \
  --output "$TEMP_JSON" \
  --format json

# Step 2: Generate markdown
echo ""
echo "Step 2: Generating markdown documentation..."
readonly TEMP_MD="/tmp/aztec_api_auto_$(date +%s).md"
python3 "$SCRIPT_DIR/transform_to_markdown.py" \
  --input "$TEMP_JSON" \
  --output "$TEMP_MD" \
  --title "$TITLE"

# Step 3: Add front-matter
readonly TEMP_WITH_FRONTMATTER="/tmp/aztec_api_final_$(date +%s).md"

cat > "$TEMP_WITH_FRONTMATTER" << EOF
---
title: ${TITLE} (Auto-generated)
description: Comprehensive auto-generated reference for the Aztec.js TypeScript library with all classes, interfaces, types, and functions.
tags: [api, reference, autogenerated, aztec.js, typescript]
sidebar_position: ${SIDEBAR_POSITION}
---

# ${TITLE}

*This documentation is auto-generated from the Aztec.js TypeScript source code.*

:::info
This is an auto-generated reference. For tutorials and guides, see the [Aztec.js Guide](./index.md).
:::

EOF

# Append markdown content (skip first line which is duplicate title)
tail -n +2 "$TEMP_MD" >> "$TEMP_WITH_FRONTMATTER"

# Step 4: Deploy to target locations
echo ""
echo "Step 3: Deploying documentation..."

update_version() {
  local version=$1
  local target_dir=""

  if [[ "$version" == "current" ]]; then
    target_dir="$DOCS_ROOT/docs/developers/docs/aztec-js"
  else
    target_dir="$DOCS_ROOT/versioned_docs/version-${version}/developers/docs/aztec-js"
  fi

  if [[ ! -d "$target_dir" ]]; then
    echo "  Warning: Directory not found: $target_dir"
    return 1
  fi

  cp "$TEMP_WITH_FRONTMATTER" "$target_dir/$OUTPUT_FILE"
  echo "  âœ“ Updated $version"
  return 0
}

case "$TARGET_VERSION" in
  all)
    # Update main docs
    update_version "current" || true

    # Update all versioned docs
    if [[ -f "$DOCS_ROOT/versions.json" ]]; then
      # Use jq if available for robust JSON parsing, otherwise fallback to grep
      if command -v jq &> /dev/null; then
        versions=$(jq -r '.[]' "$DOCS_ROOT/versions.json")
      else
        versions=$(grep -o '"v[^"]*"' "$DOCS_ROOT/versions.json" | tr -d '"')
      fi

      for version in $versions; do
        update_version "$version" || true
      done
    fi
    ;;
  current)
    update_version "current"
    ;;
  *)
    update_version "$TARGET_VERSION"
    ;;
esac

# Cleanup
rm -f "$TEMP_JSON" "$TEMP_MD" "$TEMP_WITH_FRONTMATTER"

echo ""
echo "=== Documentation Update Complete ==="
echo ""
echo "Files updated with auto-generated Aztec.js API reference."
echo "You can now commit these changes to the repository."
