#!/bin/bash
# Script to regenerate auto-generated Aztec.js API documentation using TypeDoc
# Usage: ./scripts/aztecjs_reference_generation/update_typedoc_docs.sh [target_version]
#
# Examples:
#   ./scripts/aztecjs_reference_generation/update_typedoc_docs.sh                    # Updates all versions
#   ./scripts/aztecjs_reference_generation/update_typedoc_docs.sh current            # Updates current only
#   ./scripts/aztecjs_reference_generation/update_typedoc_docs.sh v2.0.2             # Updates v2.0.2 only

set -euo pipefail

TARGET_VERSION="${1:-all}"

# Constants
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCS_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
readonly SCRIPT_DIR DOCS_ROOT TARGET_VERSION

readonly AZTEC_JS_SRC="$SCRIPT_DIR/../../../yarn-project/aztec.js/src"
readonly OUTPUT_FILE="aztec_js_reference_typedoc.md"
readonly SIDEBAR_POSITION="99"
readonly TITLE="Aztec.js API Reference (TypeDoc)"

echo "=== Aztec.js API Documentation Update Script (TypeDoc) ==="
echo ""

# Verify source directory exists
if [[ ! -d "$AZTEC_JS_SRC" ]]; then
  echo "Error: Source directory not found: $AZTEC_JS_SRC"
  exit 1
fi

# Step 1: Generate TypeDoc markdown files
echo "Step 1: Generating TypeDoc markdown files..."
readonly TEMP_TYPEDOC_DIR="/tmp/aztec_typedoc_$(date +%s)"
mkdir -p "$TEMP_TYPEDOC_DIR"

cd "$DOCS_ROOT"
yarn typedoc --options typedoc.json --out "$TEMP_TYPEDOC_DIR" 2>&1 | grep -E "(error|warning|info)" || true

if [[ ! -d "$TEMP_TYPEDOC_DIR" ]] || [[ -z "$(ls -A "$TEMP_TYPEDOC_DIR")" ]]; then
  echo "Error: TypeDoc generation failed or produced no output"
  exit 1
fi

# Step 2: Merge TypeDoc files into single markdown
echo ""
echo "Step 2: Merging TypeDoc files into single markdown..."
readonly TEMP_MD="/tmp/aztec_typedoc_merged_$(date +%s).md"
node "$DOCS_ROOT/scripts/merge_typedoc.js" "$TEMP_TYPEDOC_DIR" "$TEMP_MD"

# Step 3: Add front-matter
readonly TEMP_WITH_FRONTMATTER="/tmp/aztec_typedoc_final_$(date +%s).md"

cat > "$TEMP_WITH_FRONTMATTER" << EOF
---
title: ${TITLE}
description: Comprehensive auto-generated reference for the Aztec.js TypeScript library generated with TypeDoc - includes source links and cross-references.
tags: [api, reference, autogenerated, aztec.js, typescript, typedoc]
sidebar_position: ${SIDEBAR_POSITION}
---

# ${TITLE}

*This documentation is auto-generated from the Aztec.js TypeScript source code using TypeDoc.*

:::info
This is an auto-generated reference using TypeDoc. For tutorials and guides, see the [Aztec.js Guide](./index.md).
:::


EOF

# Append markdown content (skip first line which is duplicate title)
tail -n +2 "$TEMP_MD" >> "$TEMP_WITH_FRONTMATTER"

# Step 4: Deploy to target locations
echo ""
echo "Step 3: Deploying documentation..."

update_version() {
  local version=$1
  local target_dir=""

  if [[ "$version" == "current" ]]; then
    target_dir="$DOCS_ROOT/docs/developers/docs/aztec-js"
  else
    target_dir="$DOCS_ROOT/versioned_docs/version-${version}/developers/docs/aztec-js"
  fi

  if [[ ! -d "$target_dir" ]]; then
    echo "  Warning: Directory not found: $target_dir"
    return 1
  fi

  cp "$TEMP_WITH_FRONTMATTER" "$target_dir/$OUTPUT_FILE"
  echo "  âœ“ Updated $version"
  return 0
}

case "$TARGET_VERSION" in
  all)
    # Update main docs
    update_version "current" || true

    # Update all versioned docs
    if [[ -f "$DOCS_ROOT/versions.json" ]]; then
      # Use jq if available for robust JSON parsing, otherwise fallback to grep
      if command -v jq &> /dev/null; then
        versions=$(jq -r '.[]' "$DOCS_ROOT/versions.json")
      else
        versions=$(grep -o '"v[^"]*"' "$DOCS_ROOT/versions.json" | tr -d '"')
      fi

      for version in $versions; do
        update_version "$version" || true
      done
    fi
    ;;
  current)
    update_version "current"
    ;;
  *)
    update_version "$TARGET_VERSION"
    ;;
esac

# Cleanup
rm -rf "$TEMP_TYPEDOC_DIR"
rm -f "$TEMP_MD" "$TEMP_WITH_FRONTMATTER"

echo ""
echo "=== Documentation Update Complete ==="
echo ""
echo "Files updated with auto-generated Aztec.js API reference (TypeDoc)."
echo "You can now commit these changes to the repository."
echo ""
echo "To view differences between approaches:"
echo "  Custom:  docs/developers/docs/aztec-js/aztec_js_reference_autogen.md"
echo "  TypeDoc: docs/developers/docs/aztec-js/aztec_js_reference_typedoc.md"
echo ""
