#!/bin/bash
# Unified script to regenerate auto-generated CLI documentation
# Usage: ./scripts/cli_reference_generation/update_cli_docs.sh <cli_name> [target_version]
#
# Examples:
#   ./scripts/cli_reference_generation/update_cli_docs.sh aztec                    # Updates aztec CLI, all versions
#   ./scripts/cli_reference_generation/update_cli_docs.sh aztec-wallet current     # Updates aztec-wallet CLI, current only
#   ./scripts/cli_reference_generation/update_cli_docs.sh aztec v2.0.2             # Updates aztec CLI, v2.0.2 only

set -euo pipefail  # Added 'u' for undefined variable check, 'o pipefail' for pipe failures

# Validate arguments
if [[ $# -lt 1 ]]; then
  echo "Error: CLI name is required"
  echo "Usage: $0 <cli_name> [target_version]"
  echo "  cli_name: 'aztec' or 'aztec-wallet'"
  echo "  target_version: 'all' (default), 'current', or version like 'v2.0.2'"
  exit 1
fi

CLI_NAME="$1"
TARGET_VERSION="${2:-all}"

# Validate CLI name
if [[ "$CLI_NAME" != "aztec" && "$CLI_NAME" != "aztec-wallet" ]]; then
  echo "Error: Invalid CLI name '$CLI_NAME'. Must be 'aztec' or 'aztec-wallet'"
  exit 1
fi

# Constants
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCS_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
readonly SCRIPT_DIR DOCS_ROOT TARGET_VERSION CLI_NAME

# Create temporary directory with automatic cleanup
TEMP_DIR=$(mktemp -d) || {
  echo "Error: Failed to create temporary directory"
  exit 1
}
trap 'rm -rf "$TEMP_DIR"' EXIT INT TERM

readonly TEMP_JSON="$TEMP_DIR/cli_docs.json"
readonly TEMP_MD="$TEMP_DIR/cli_auto.md"
readonly TEMP_WITH_FRONTMATTER="$TEMP_DIR/cli_final.md"

# Configuration per CLI (compatible with bash 3.2+)
case "$CLI_NAME" in
  aztec)
    DISPLAY_NAME="Aztec CLI"
    TITLE="Aztec CLI Reference"
    OUTPUT_FILE="cli_reference_autogen.md"
    SIDEBAR_POSITION="3"
    MANUAL_REF_FILE="cli_reference.md"
    COMMAND="aztec"
    ;;
  aztec-wallet)
    DISPLAY_NAME="Aztec Wallet CLI"
    TITLE="Aztec Wallet CLI Reference"
    OUTPUT_FILE="cli_wallet_reference_autogen.md"
    SIDEBAR_POSITION="10"
    MANUAL_REF_FILE="cli_wallet_reference.md"
    COMMAND="aztec-wallet"
    ;;
esac

echo "=== ${DISPLAY_NAME} Documentation Update Script ==="
echo ""

# Step 1: Generate JSON from CLI
echo "Step 1: Scanning ${COMMAND} CLI commands..."
python3 "$SCRIPT_DIR/scan_cli.py" --command "$COMMAND" --output "$TEMP_JSON"

# Step 2: Generate markdown
echo ""
echo "Step 2: Generating markdown documentation..."
python3 "$SCRIPT_DIR/transform_to_markdown.py" \
  --input "$TEMP_JSON" \
  --output "$TEMP_MD" \
  --title "$TITLE"

# Step 3: Add front-matter

# Determine tags based on CLI
TAGS="[cli, reference, autogenerated"
[[ "$CLI_NAME" == "aztec-wallet" ]] && TAGS+=", wallet"
TAGS+="]"

cat > "$TEMP_WITH_FRONTMATTER" << EOF
---
title: ${TITLE} (Auto-generated)
description: Comprehensive auto-generated reference for the ${DISPLAY_NAME} command-line interface with all commands and options.
tags: ${TAGS}
sidebar_position: ${SIDEBAR_POSITION}
---

# ${TITLE}

*This documentation is auto-generated from the \`${COMMAND}\` CLI help output.*

:::info
This is an auto-generated reference. For a more curated guide with examples and best practices, see the [manual ${DISPLAY_NAME} reference](${MANUAL_REF_FILE}).
:::

EOF

# Append markdown content (skip first line which is duplicate title)
tail -n +2 "$TEMP_MD" >> "$TEMP_WITH_FRONTMATTER"

# Step 4: Deploy to target locations
echo ""
echo "Step 3: Deploying documentation..."

update_version() {
  local version=$1
  local target_dir=""
  local cli_dir=""

  # Determine CLI-specific directory
  case "$CLI_NAME" in
    aztec)
      cli_dir="aztec-cli"
      ;;
    aztec-wallet)
      cli_dir="wallet-cli"
      ;;
  esac

  if [[ "$version" == "current" ]]; then
    target_dir="$DOCS_ROOT/docs/developers/docs/${cli_dir}"
  else
    target_dir="$DOCS_ROOT/versioned_docs/version-${version}/developers/docs/${cli_dir}"
  fi

  if [[ ! -d "$target_dir" ]]; then
    echo "  Warning: Directory not found: $target_dir"
    return 1
  fi

  cp "$TEMP_WITH_FRONTMATTER" "$target_dir/$OUTPUT_FILE"
  echo "  âœ“ Updated $version"
  return 0
}

case "$TARGET_VERSION" in
  all)
    # Update main docs
    update_version "current" || true

    # Update all versioned docs
    if [[ -f "$DOCS_ROOT/versions.json" ]]; then
      # Use jq if available for robust JSON parsing, otherwise fallback to grep
      if command -v jq &> /dev/null; then
        versions=$(jq -r '.[]' "$DOCS_ROOT/versions.json")
      else
        versions=$(grep -o '"v[^"]*"' "$DOCS_ROOT/versions.json" | tr -d '"')
      fi

      for version in $versions; do
        update_version "$version" || true
      done
    fi
    ;;
  current)
    update_version "current"
    ;;
  *)
    update_version "$TARGET_VERSION"
    ;;
esac

# Cleanup handled automatically by trap
echo ""
echo "=== Documentation Update Complete ==="
echo ""
echo "Files updated with auto-generated ${DISPLAY_NAME} reference."
echo "You can now commit these changes to the repository."
