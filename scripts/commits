#!/usr/bin/env python3

import sys
import subprocess
import re
import os
from datetime import datetime
from typing import List, Tuple, Optional

# ANSI color codes
RESET = '\033[0m'
BOLD = '\033[1m'
DIM = '\033[2m'
YELLOW = '\033[38;2;250;217;121m'
GREEN = '\033[38;2;97;214;104m'
BLUE = '\033[38;2;95;167;241m'
PURPLE = '\033[38;2;188;109;208m'
GRAY = '\033[0;90m'
DARK_GRAY = '\033[38;5;240m'  # Different gray for subsystem labels
WHITE = '\033[37m'  # White for regular commit text

def run_command(cmd: List[str]) -> str:
    """Run a command and return its output."""
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return ""

def get_pr_number(message: str) -> Optional[str]:
    """Extract PR number from commit message."""
    match = re.search(r'#(\d+)', message)
    return match.group(1) if match else None

def get_commit_color_and_split(message: str) -> tuple:
    """Get color based on commit type and split the message into colored and white parts."""
    # Check for patterns like "feat(...): " or "fix!: " etc
    import re
    
    # Match conventional commit format: type(scope)!: or type:
    match = re.match(r'^(fix|feat|chore|refactor|docs|style|test|perf|ci|build|revert)(\([^)]+\))?(!)?(:)', message)
    
    if match:
        prefix = match.group(0)[:-1]  # Everything except the colon
        rest = message[match.end()-1:]  # From colon onwards
        
        if message.startswith('fix'):
            return GREEN, prefix, rest
        elif message.startswith('feat'):
            return BLUE, prefix, rest
        elif message.startswith('chore'):
            return GRAY, prefix, rest
        elif message.startswith('refactor'):
            return PURPLE, prefix, rest
        else:
            return "", prefix, rest
    
    # No conventional commit format found
    return "", "", message

def term_link(url: str, text: str) -> str:
    """Create a terminal hyperlink."""
    return f'\033]8;;{url}\033\\{text}\033]8;;\033\\'

def format_author_date(author: str, date: str, current_length: int, max_width: int = 120) -> str:
    """Format author and date aligned to the right."""
    author_date = f"[{date}] {GREEN}{author}{RESET}"
    # Need to account for ANSI codes in length calculation
    visible_author_date = f"[{date}] {author}"
    padding = max_width - current_length - len(visible_author_date)
    
    if padding > 0:
        return " " * padding + author_date
    else:
        return " " + author_date

def visible_length(text: str) -> int:
    """Calculate visible length of text (without ANSI codes)."""
    # Remove ANSI color codes
    text = re.sub(r'\033\[[0-9;]*m', '', text)
    # Remove terminal hyperlink sequences
    text = re.sub(r'\033\]8[^\\]*\\', '', text)
    return len(text)

def get_merge_train_commits(merge_commit: str) -> List[str]:
    """Get commits in a merge train."""
    # Get the first parent (the commit this was merged into)
    first_parent_cmd = ['git', 'rev-parse', f'{merge_commit}^1']
    first_parent = run_command(first_parent_cmd)
    
    if not first_parent:
        return []
    
    # Get all commits in the merge train branch
    commits_cmd = ['git', 'rev-list', '--reverse', f'{first_parent}..{merge_commit}^2']
    commits_output = run_command(commits_cmd)
    
    if not commits_output:
        return []
    
    commits = []
    for commit in commits_output.split('\n'):
        if not commit:
            continue
            
        # Get the commit message
        message_cmd = ['git', 'log', '--format=%s', '-n1', commit]
        message = run_command(message_cmd)
        
        # Skip merge commits without PR numbers
        if message.startswith('Merge branch') and '#' not in message:
            continue
            
        commits.append(commit)
    
    return commits

def process_commit(commit: str, indent: str = "", message: str = "", 
                  author: str = "", date: str = "", merge_train_prefix: str = "") -> str:
    """Process and format a single commit."""
    # Extract PR number if present
    pr_num = get_pr_number(message)
    pr_link = ""
    if pr_num:
        pr_url = f"https://github.com/AztecProtocol/aztec-packages/pull/{pr_num}"
        pr_link = f" ({term_link(pr_url, f'#{YELLOW}{pr_num}{RESET}')})"
    
    # Clean message (remove PR number from display)
    clean_message = re.sub(r' \(#\d+\)$', '', message)
    
    # Get color and split message
    commit_color, colored_prefix, white_rest = get_commit_color_and_split(clean_message)
    
    # Format the message with colored prefix and white rest
    if colored_prefix:
        formatted_message = f"{commit_color}{colored_prefix}{WHITE}{white_rest}{RESET}"
    else:
        formatted_message = f"{WHITE}{clean_message}{RESET}"
    
    # For merge-train children, use the subsystem prefix instead of commit hash
    if merge_train_prefix:
        # Abbreviate barretenberg to bb
        prefix_display = "bb" if merge_train_prefix == "barretenberg" else merge_train_prefix
        # Use the subsystem name in brackets with a different gray
        # Pad the visible part to align with commit hashes (8 chars including space)
        visible_part = f"[{prefix_display}]"
        padded_visible = visible_part.ljust(8)
        commit_part = f"{DARK_GRAY}{visible_part}{RESET}{' ' * (8 - len(visible_part))}"
    else:
        # Make commit hash a clickable link
        commit_url = f"https://github.com/AztecProtocol/aztec-packages/commit/{commit}"
        commit_part = f"{term_link(commit_url, f'{YELLOW}{commit[:7]}{RESET}')} "
    
    # Build the left part of the line
    left_part = f"{indent}{commit_part}{formatted_message}{pr_link}"
    
    # Calculate visible length for alignment
    vis_length = visible_length(left_part)
    
    # Format with right-aligned author and date
    author_date = format_author_date(author, date, vis_length)
    
    return left_part + author_date

def echo_header(text: str) -> None:
    """Print a formatted header."""
    print(f"{PURPLE}---{RESET} {BLUE}{BOLD}{text}{RESET} {PURPLE}---{RESET}")

def main():
    # Parse arguments
    branch = sys.argv[1] if len(sys.argv) > 1 else "HEAD"
    limit = int(sys.argv[2]) if len(sys.argv) > 2 else 50
    
    # Print header
    echo_header(f"Commits on {branch} (linear with merge trains grouped)")
    
    # Get all commits with their details
    log_cmd = ['git', 'log', '--first-parent', f'--format=%H|%s|%an|%ar', branch, '-n', str(limit)]
    log_output = run_command(log_cmd)
    
    if not log_output:
        print("No commits found.")
        return
    
    for line in log_output.split('\n'):
        if not line:
            continue
            
        parts = line.split('|', 3)
        if len(parts) != 4:
            continue
            
        commit, message, author, date = parts
        
        # Check if this is a merge train commit
        if 'merge-train/' in message and '#' in message:
            # Extract subsystem name from merge-train/subsystem
            subsystem_match = re.search(r'merge-train/([^\s]+)', message)
            subsystem = subsystem_match.group(1) if subsystem_match else "merge-train"
            
            # For merge train commits, show only the hash and PR link (no message)
            pr_num = get_pr_number(message)
            pr_link = ""
            if pr_num:
                pr_url = f"https://github.com/AztecProtocol/aztec-packages/pull/{pr_num}"
                pr_link = f" ({term_link(pr_url, f'#{YELLOW}{pr_num}{RESET}')})"
            
            # Make commit hash a clickable link
            commit_url = f"https://github.com/AztecProtocol/aztec-packages/commit/{commit}"
            commit_link = term_link(commit_url, f'{YELLOW}{commit[:7]}{RESET}')
            
            # Show "merge-train" in dim text
            print(f"* {commit_link} {DIM}merge-train{RESET}{pr_link}")
            
            # Get and display commits within the merge train
            train_commits = get_merge_train_commits(commit)
            for train_commit in train_commits:
                if train_commit:
                    # Get commit details
                    detail_cmd = ['git', 'log', '--format=%s|%an|%ar', '-n1', train_commit]
                    train_details = run_command(detail_cmd)
                    if train_details:
                        train_parts = train_details.split('|', 2)
                        if len(train_parts) == 3:
                            train_message, train_author, train_date = train_parts
                            print(process_commit(train_commit, "  ", train_message, 
                                               train_author, train_date, subsystem))
        else:
            # Skip merge commits without PR numbers
            if message.startswith('Merge') and '#' not in message:
                continue
            
            # Regular commit
            print(process_commit(commit, "", message, author, date))
    
    print()
    print(f"{BOLD}Showing up to {limit} commits. Use '{sys.argv[0]} {branch} <number>' to see more.{RESET}")

if __name__ == "__main__":
    main()