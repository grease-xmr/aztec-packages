global:
  aztecRollupVersion: "canonical"
  aztecNetwork: ""
  customAztecNetwork:
    enabled: false

bot:
  mnemonic: "test test test test test test test test test test test junk"
  mnemonicStartIndex: 3000
  txIntervalSeconds: 1
  privateTransfersPerTx: 0
  publicTransfersPerTx: 1
  # Do not wait for transactions
  followChain: "NONE"
  botNoStart: false
  feePaymentMethod: "fee_juice"
  ammTxs: false
  maxErrors: 3
  stopIfUnhealthy: true
  nodeUrl: ""
  testAccounts: false
  botPrivateKey: "0xcafe"

  persistence:
    enabled: false
  statefulSet:
    enabled: true

  replicaCount: 1

  initContainers:
    - name: wait-for-block-production
      image: curlimages/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          AZTEC_NODE_URL="${AZTEC_NODE_URL}"
          if [ -z "$AZTEC_NODE_URL" ]; then
            echo "AZTEC_NODE_URL not set, skipping block production wait"
            exit 0
          fi

          echo "Waiting for Aztec Node to be available at ${AZTEC_NODE_URL}..."
          until curl -s ${AZTEC_NODE_URL}/status > /dev/null; do
            echo "Waiting for aztec-node..."
            sleep 2
          done
          echo "Aztec Node is ready"

          echo "Waiting for block production to start..."
          TIMEOUT=300
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            BLOCK_NUMBER=$(curl -s -X POST -H 'Content-Type: application/json' \
              -d '{"jsonrpc":"2.0","method":"node_getBlockNumber","params":[],"id":1}' \
              ${AZTEC_NODE_URL} | grep -o '"result":[0-9]*' | cut -d':' -f2)

            if [ ! -z "$BLOCK_NUMBER" ] && [ "$BLOCK_NUMBER" -gt 0 ]; then
              echo "Block production has started. Current block number: $BLOCK_NUMBER"
              exit 0
            fi

            echo "Block number is still 0 or not available, waiting... (${ELAPSED}s/${TIMEOUT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          echo "WARNING: Timed out waiting for block production to start after ${TIMEOUT}s"
          echo "Proceeding anyway..."
          exit 0
      envFrom:
        - configMapRef:
            name: "{{ .Release.Name }}-env"

  node:
    configMap:
      envEnabled: true
    secret:
      envEnabled: true

    preStartScript: |
      source /scripts/get-private-key.sh

      export BOT_ACCOUNT_SALT=$(echo $K8S_POD_NAME | awk -F'-' '{print $NF+1}') # +1 so that salt is not 0

      # set this to a folder in order to capture simulation recordings for later debug
      # be sure to set it to a persistent volume
      export CIRCUIT_RECORD_DIR=""

    startCmd:
      - --bot
      - --pxe

    hostNetwork: false

  service:
    p2p:
      enabled: false
      nodePortEnabled: false
    admin:
      enabled: false
    headless:
      enabled: false
